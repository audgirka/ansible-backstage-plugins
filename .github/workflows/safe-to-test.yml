name: Safe to Test

# Reusable workflow to gate pull_request_target workflows
# Prevents "pwn request" attacks by requiring authorization before running untrusted code
# https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/
#
# Usage in other workflows:
#   jobs:
#     authorize:
#       uses: ./.github/workflows/safe-to-test.yml
#       secrets: inherit
#
#     my-job:
#       needs: [authorize]
#       if: needs.authorize.outputs.is_authorized == 'true'
#       ...

on:
  workflow_call:
    outputs:
      is_authorized:
        description: "Whether the PR is authorized to run privileged workflows"
        value: ${{ jobs.check.outputs.is_authorized }}

jobs:
  check:
    name: Authorization Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      is_authorized: ${{ steps.final-check.outputs.is_authorized }}
    steps:
      - name: Check if PR author is a collaborator
        id: authorization
        run: |
          user_role=$(gh api --jq .permission \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/collaborators/${{ github.event.pull_request.user.login }}/permission") || user_role="none"
          
          echo "PR author: ${{ github.event.pull_request.user.login }}, role: $user_role"
          
          # Check if user has write, maintain, or admin permissions
          if [[ "$user_role" == "write" || "$user_role" == "maintain" || "$user_role" == "admin" ]]; then
            echo "is_collaborator=true" >> $GITHUB_OUTPUT
            echo "‚úÖ User is a collaborator with $user_role permission"
          else
            echo "is_collaborator=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è User is not a collaborator (role: $user_role)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Auto-add 'safe to test' label for collaborators
      - name: Add 'safe to test' label for collaborators
        if: steps.authorization.outputs.is_collaborator == 'true'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-label "safe to test"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # For non-collaborators: check and potentially remove label if PR was updated
      - name: Check for existing 'safe to test' label
        id: check-label
        if: steps.authorization.outputs.is_collaborator == 'false'
        run: |
          SAFE_LABEL=$(gh api --jq '.[] | select(.name == "safe to test") | .name' \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels") || true
          echo "safe_label=$SAFE_LABEL" >> $GITHUB_OUTPUT
          echo "Current 'safe to test' label: ${SAFE_LABEL:-not present}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Remove label if non-collaborator pushed new commits (prevents malicious code after approval)
      - name: Remove 'safe to test' label on PR update (non-collaborator)
        if: |
          steps.authorization.outputs.is_collaborator == 'false' &&
          steps.check-label.outputs.safe_label != '' &&
          github.event.label.name != 'safe to test' &&
          (github.event.action == 'synchronize' || github.event.action == 'reopened')
        run: |
          echo "üîí Removing 'safe to test' label - PR was updated by non-collaborator"
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "safe to test"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Final authorization check
      - name: Verify authorization
        id: final-check
        run: |
          LABELS=$(gh api -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}" \
            --jq '.labels[].name') || true
          
          if echo "$LABELS" | grep -q "safe to test"; then
            echo "is_authorized=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR has 'safe to test' label - authorized to proceed"
          else
            echo "is_authorized=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR does not have 'safe to test' label"
            echo ""
            echo "For external contributors: A maintainer must add the 'safe to test' label after reviewing the PR code."
            echo "For collaborators: This should have been added automatically. Please check your repository permissions."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
